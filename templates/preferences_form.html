{% extends "base.html" %}

{% block title %}{{ pediatrician.name }} - Preferencias{% endblock %}

{% block extra_styles %}
<style>
    form label {
        display: inline-block;
        margin-top: 10px;
        font-weight: bold;
    }

    form input,
    form select {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }

    form button {
        margin-top: 15px;
        padding: 10px 20px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    form button:hover {
        background-color: #2980b9;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    table th,
    table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    table th {
        background-color: #f2f2f2;
        font-weight: bold;
    }

    .delete-btn {
        background-color: #e74c3c;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .delete-btn:hover {
        background-color: #c0392b;
    }

    .mode-selector {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }

    .mode-option {
        padding: 10px 20px;
        border: 2px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .mode-option:hover {
        border-color: #3498db;
        background-color: #f0f8ff;
    }

    .mode-option.active {
        border-color: #3498db;
        background-color: #3498db;
        color: white;
    }

    .form-section {
        display: none;
    }

    .form-section.active {
        display: block;
    }

    .date-range {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .recurring-badge {
        display: inline-block;
        background: #3498db;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin-left: 8px;
    }
</style>
{% endblock %}

{% block content %}
<h1>{{ pediatrician.name}} - Preferencias de Guardias</h1>

<div style="background: #e8f4f8; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
    <h2 style="margin-top: 0;">A√±adir Preferencia</h2>

    <!-- Mode Selector -->
    <div class="mode-selector">
        <div class="mode-option active" onclick="selectMode('specific')">
            üìÖ Fecha Espec√≠fica
        </div>
        <div class="mode-option" onclick="selectMode('range')">
            üóìÔ∏è Rango de Fechas
        </div>
        <div class="mode-option" onclick="selectMode('recurring')">
            üîÑ D√≠a de la Semana (Recurrente)
        </div>
    </div>

    <form method="POST" id="preference-form">
        <input type="hidden" name="preference_mode" id="preference_mode" value="specific">

        <!-- Specific Date Section -->
        <div id="specific-section" class="form-section active">
            <label for="req_date">Fecha:</label>
            <input type="date" id="req_date" name="request_date">
        </div>

        <!-- Date Range Section -->
        <div id="range-section" class="form-section">
            <div class="date-range">
                <div>
                    <label for="range_start">Desde:</label>
                    <input type="date" id="range_start" name="range_start">
                </div>
                <div>
                    <label for="range_end">Hasta:</label>
                    <input type="date" id="range_end" name="range_end">
                </div>
            </div>
        </div>

        <!-- Recurring Weekday Section -->
        <div id="recurring-section" class="form-section">
            <label for="weekday">D√≠a de la Semana:</label>
            <select id="weekday" name="weekday">
                <option value="">Seleccionar d√≠a...</option>
                <option value="monday">Lunes</option>
                <option value="tuesday">Martes</option>
                <option value="wednesday">Mi√©rcoles</option>
                <option value="thursday">Jueves</option>
                <option value="friday">Viernes</option>
                <option value="saturday">S√°bado</option>
                <option value="sunday">Domingo</option>
            </select>

            <div class="date-range">
                <div>
                    <label for="start_month">Desde (Mes/A√±o):</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="start_month" name="start_month" style="flex: 1;">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        <input type="number" id="start_year" name="start_year" placeholder="A√±o" min="2025" max="2030"
                            value="2026" style="flex: 1;">
                    </div>
                </div>

                <div>
                    <label for="end_month">Hasta (Mes/A√±o):</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="end_month" name="end_month" style="flex: 1;">
                            <option value="1">Enero</option>
                            <option value="2">Febrero</option>
                            <option value="3">Marzo</option>
                            <option value="4">Abril</option>
                            <option value="5">Mayo</option>
                            <option value="6">Junio</option>
                            <option value="7">Julio</option>
                            <option value="8">Agosto</option>
                            <option value="9">Septiembre</option>
                            <option value="10">Octubre</option>
                            <option value="11">Noviembre</option>
                            <option value="12">Diciembre</option>
                        </select>
                        <input type="number" id="end_year" name="end_year" placeholder="A√±o" min="2025" max="2030"
                            value="2026" style="flex: 1;">
                    </div>
                </div>
            </div>
        </div>

        <label for="req_type">Tipo de Preferencia:</label>
        <select id="req_type" name="request_type" required>
            <option value="Vacation">Vacation (Vacaciones)</option>
            <option value="Skip">Skip (No disponible)</option>
            <option value="Prefer">Prefer (Prefiero trabajar)</option>
            <option value="Prefer Not">Prefer Not (Prefiero no trabajar)</option>
            <option value="Mandatory">Mandatory (Obligatorio/Guardia Impuesta)</option>
        </select>

        <button type="submit">Guardar Preferencia</button>
    </form>
</div>

<!-- Display Recurring Preferences -->
{% if recurring_prefs %}
<h2>Preferencias Recurrentes (D√≠a de la Semana)</h2>
<table>
    <thead>
        <tr>
            <th>D√≠a de la Semana</th>
            <th>Tipo</th>
            <th>Rango</th>
            <th>Cantidad</th>
            <th>Acci√≥n</th>
        </tr>
    </thead>
    <tbody>
        {% for pref in recurring_prefs %}
        <tr>
            <td><strong>{{ pref.weekday }}</strong></td>
            <td>{{ pref.type }}</td>
            <td>{{ pref.start_date.strftime('%b %Y') }} - {{ pref.end_date.strftime('%b %Y') }}</td>
            <td><span class="recurring-badge">{{ pref.count }} d√≠as</span></td>
            <td>
                <form method="POST" style="display: inline;">
                    <input type="hidden" name="delete_recurring_group" value="{{ pref.group_id }}">
                    <button type="submit" class="delete-btn"
                        onclick="return confirm('¬øEliminar todas las {{ pref.count }} preferencias de {{ pref.weekday }}?')">Eliminar</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<!-- Calendar Visualization -->
<h2>Calendario de Preferencias</h2>
<div class="calendar-container">
    <div class="calendar-header">
        <button type="button" onclick="changeMonth(-1)">‚óÄ Mes Anterior</button>
        <h3 id="calendar-month-year" style="margin:0;"></h3>
        <button type="button" onclick="changeMonth(1)">Mes Siguiente ‚ñ∂</button>
    </div>
    <div class="calendar-grid" id="calendar-grid">
        <!-- Generated by JS -->
    </div>
    <div class="calendar-legend">
        <div class="legend-item"><span class="dot" style="background: #e74c3c;"></span> Skip (No disponible)</div>
        <div class="legend-item"><span class="dot" style="background: #3498db;"></span> Vacation (Vacaciones)</div>
        <div class="legend-item"><span class="dot" style="background: #2ecc71;"></span> Prefer (Prefiero)</div>
        <div class="legend-item"><span class="dot" style="background: #f1c40f;"></span> Prefer Not (Prefiero no)</div>
        <div class="legend-item"><span class="dot" style="background: #8e44ad;"></span> Mandatory (Obligatorio)</div>
    </div>
    <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
        * Haz clic en una fecha para cambiar su estado (Rojo -> Azul -> Verde -> Amarillo -> Violeta -> Borrar).
    </p>

    <!-- Bulk Save Form -->
    <div id="calendar-save-container"
        style="display: none; margin-top: 20px; text-align: center; border-top: 1px solid #eee; padding-top: 20px;">
        <form method="POST">
            <input type="hidden" name="preference_mode" value="calendar">
            <input type="hidden" name="calendar_changes" id="calendar_changes_input">
            <button type="submit" style="background-color: #e67e22; font-size: 1.1em; padding: 12px 30px;">
                üíæ Guardar Cambios del Calendario
            </button>
        </form>
    </div>
</div>

<style>
    .calendar-container {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        background: white;
        margin-bottom: 30px;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .calendar-header button {
        padding: 5px 10px;
        font-size: 14px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
    }

    .calendar-header button:hover {
        background: #e2e6ea;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        text-align: center;
    }

    .cal-day-header {
        font-weight: bold;
        padding: 10px;
        background: #f1f3f5;
        border-radius: 4px;
    }

    .cal-day {
        padding: 15px 5px;
        border: 1px solid #eee;
        border-radius: 4px;
        cursor: pointer;
        position: relative;
        min-height: 50px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .cal-day:hover {
        background-color: #f8f9fa;
        border-color: #3498db;
    }

    .cal-day.empty {
        background: transparent;
        border: none;
        cursor: default;
    }

    .cal-event-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-top: 5px;
    }

    .calendar-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }

    .legend-item {
        display: flex;
        align-items: center;
        font-size: 14px;
    }

    .legend-item .dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
        display: inline-block;
    }
</style>

<script>
    // Received from Flask
    const rawPrefs = {{ prefs_json | tojson }};
    // Convert to map: 'YYYY-MM-DD' -> 'Type'
    const prefsMap = {};
    rawPrefs.forEach(p => {
        prefsMap[p.date] = p.type;
    });

    let currentDate = new Date();
    // Start with current month or next relevant month? 
    // Let's default to today's month, user can navigate.

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth(); // 0-11

        // Update Header
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        document.getElementById('calendar-month-year').textContent = `${monthNames[month]} ${year}`;

        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';

        // Weekday Headers
        const days = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        // Adjust for Monday start? The python expands weekday 0=Monday.
        // Javascript 0=Sunday.
        // Let's use standard Monday start for Europe/Spain
        const daysMon = ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'];
        daysMon.forEach(d => {
            const el = document.createElement('div');
            el.className = 'cal-day-header';
            el.textContent = d;
            grid.appendChild(el);
        });

        // Days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0); // Last day of current month

        // Calculate offset (Monday start)
        // JS getDay(): 0=Sun, 1=Mon... 6=Sat
        // We want 0=Mon ... 6=Sun
        let startDay = firstDay.getDay() - 1;
        if (startDay === -1) startDay = 6;

        const totalDays = lastDay.getDate();

        // Empty slots
        for (let i = 0; i < startDay; i++) {
            const blank = document.createElement('div');
            blank.className = 'cal-day empty';
            grid.appendChild(blank);
        }

        // Date slots
        for (let d = 1; d <= totalDays; d++) {
            const cell = document.createElement('div');
            cell.className = 'cal-day';

            // Format YYYY-MM-DD
            const currentMonthStr = String(month + 1).padStart(2, '0');
            const dayStr = String(d).padStart(2, '0');
            const dateStr = `${year}-${currentMonthStr}-${dayStr}`;

            cell.innerHTML = `<span>${d}</span>`;

            // Check for preference
            if (prefsMap[dateStr]) {
                const type = prefsMap[dateStr];
                const dot = document.createElement('div');
                dot.className = 'cal-event-dot';

                // Color mapping
                if (type === 'Skip') dot.style.background = '#e74c3c'; // Red
                else if (type === 'Vacation') dot.style.background = '#3498db'; // Blue
                else if (type === 'Prefer') dot.style.background = '#2ecc71'; // Green
                else if (type === 'Prefer Not') dot.style.background = '#f1c40f'; // Yellow
                else if (type === 'Mandatory') dot.style.background = '#8e44ad'; // Purple

                cell.appendChild(dot);
                cell.title = type; // Tooltip
            }

            // Click handler
            cell.onclick = () => {
                // If user wants to just pick date for "Fecha Espec√≠fica" form, they can still do it? 
                // The requirement is "interactively click... then add a button... to save".
                // So we hijack the click for this new feature.
                // But we should probably also update the form inputs just in case they want to use the old way for that specific date?
                // Let's do both: Update form input AND cycle internal state for bulk save.

                // 1. Update form inputs (Legacy/Single support)
                selectMode('specific');
                document.getElementById('req_date').value = dateStr;

                // 2. Cycle Preference Logic
                cyclePreference(dateStr, cell);
            };

            grid.appendChild(cell);
        }
    }

    // Changes tracking: { date: 'Type' } or { date: null } (for deleted)
    const calendarChanges = {};

    const PREF_TYPES = ['Skip', 'Vacation', 'Prefer', 'Prefer Not', 'Mandatory', null];
    const PREF_COLORS = {
        'Skip': '#e74c3c', // Red
        'Vacation': '#3498db', // Blue
        'Prefer': '#2ecc71', // Green
        'Prefer Not': '#f1c40f', // Yellow
        'Mandatory': '#8e44ad', // Purple
        null: 'transparent'
    };

    function cyclePreference(dateStr, cell) {
        // Determine current type
        let currentType = null;
        if (calendarChanges.hasOwnProperty(dateStr)) {
            currentType = calendarChanges[dateStr];
        } else if (prefsMap[dateStr]) {
            currentType = prefsMap[dateStr];
        }

        // Find next index
        let idx = PREF_TYPES.indexOf(currentType);
        if (idx === -1) idx = PREF_TYPES.length - 1; // treat unknown as null?

        let nextIdx = (idx + 1) % PREF_TYPES.length;
        let nextType = PREF_TYPES[nextIdx];

        // Update tracking
        calendarChanges[dateStr] = nextType;
        document.getElementById('calendar_changes_input').value = JSON.stringify(calendarChanges);

        // Update Visuals
        let dot = cell.querySelector('.cal-event-dot');
        if (!dot) {
            dot = document.createElement('div');
            dot.className = 'cal-event-dot';
            cell.appendChild(dot);
        }

        if (nextType) {
            dot.style.background = PREF_COLORS[nextType];
            dot.style.display = 'block';
            cell.title = nextType;
        } else {
            dot.style.display = 'none';
            cell.title = '';
        }

        // Show the save button container if changes exist
        document.getElementById('calendar-save-container').style.display = 'block';
    }

    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        renderCalendar();
    }

    // Initial render
    document.addEventListener('DOMContentLoaded', renderCalendar);
</script>

<!-- Display Individual Preferences -->
<h2>Preferencias Individuales (Lista)</h2>
{% if individual_prefs %}
<table>
    <thead>
        <tr>
            <th>Fecha</th>
            <th>Tipo</th>
            <th>Acci√≥n</th>
        </tr>
    </thead>
    <tbody>
        {% for pref in individual_prefs %}
        <tr>
            <td>{{ pref.date.strftime('%Y-%m-%d') }}</td>
            <td>{{ pref.type }}</td>
            <td>
                <form method="POST" style="display: inline;">
                    <input type="hidden" name="preference_mode" value="specific">
                    <input type="hidden" name="request_date" value="{{ pref.date.strftime('%Y-%m-%d') }}">
                    <input type="hidden" name="request_type" value="Delete">
                    <button type="submit" class="delete-btn">Eliminar</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p style="color: #999; font-style: italic;">No hay preferencias individuales guardadas.</p>
{% endif %}

<script>
    function selectMode(mode) {
        // Update UI
        document.querySelectorAll('.mode-option').forEach(el => el.classList.remove('active'));
        event.target.classList.add('active');

        // Update hidden field
        document.getElementById('preference_mode').value = mode;

        // Show/hide sections
        document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
        document.getElementById(mode + '-section').classList.add('active');

        // Update required fields
        if (mode === 'specific') {
            document.getElementById('req_date').required = true;
            document.getElementById('range_start').required = false;
            document.getElementById('range_end').required = false;
            document.getElementById('weekday').required = false;
        } else if (mode === 'range') {
            document.getElementById('req_date').required = false;
            document.getElementById('range_start').required = true;
            document.getElementById('range_end').required = true;
            document.getElementById('weekday').required = false;
        } else {
            document.getElementById('req_date').required = false;
            document.getElementById('range_start').required = false;
            document.getElementById('range_end').required = false;
            document.getElementById('weekday').required = true;
        }
    }
</script>

{% endblock %}