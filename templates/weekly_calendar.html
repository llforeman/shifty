{% extends "base.html" %}


{% block title %}Agenda Semanal - Shifty{% endblock %}

{% block extra_styles %}
<style>
    .weekly-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .nav-btn {
        background-color: #3498db;
        color: white;
        padding: 8px 15px;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;
    }

    .calendar-wrapper {
        display: flex;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        position: relative;
    }

    /* Time labels column */
    .time-column {
        width: 60px;
        flex-shrink: 0;
        border-right: 1px solid #eee;
        background: #f8fafc;
    }

    .time-slot-label {
        height: 50px;
        /* 1 hour height */
        border-bottom: 1px solid #f1f1f1;
        text-align: center;
        font-size: 0.75em;
        color: #888;
        padding-top: 5px;
        box-sizing: border-box;
    }

    /* Days columns container */
    .days-grid {
        flex: 1;
        display: flex;
        overflow-x: auto;
    }

    .day-column {
        flex: 1;
        min-width: 100px;
        border-right: 1px solid #eee;
        position: relative;
    }

    .day-header {
        height: 50px;
        background: #f1f5f9;
        text-align: center;
        padding: 10px;
        border-bottom: 1px solid #ddd;
        font-weight: bold;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .day-header .date {
        display: block;
        font-size: 0.8em;
        color: #666;
        font-weight: normal;
    }

    .grid-bg-hour {
        height: 50px;
        /* Must match time-slot-label height */
        border-bottom: 1px solid #f8f9fa;
        box-sizing: border-box;
    }

    .event-card {
        position: absolute;
        border-radius: 4px;
        padding: 4px;
        color: white;
        font-size: 0.8em;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        z-index: 5;
    }

    .event-title {
        font-weight: bold;
        display: block;
    }

    .event-time {
        font-size: 0.85em;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<style>
    .view-toggle {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        display: flex;
        overflow: hidden;
    }

    .view-toggle a {
        padding: 8px 16px;
        text-decoration: none;
        color: #333;
        border-right: 1px solid #ddd;
    }

    .view-toggle a:last-child {
        border-right: none;
    }

    .view-toggle a.active {
        background-color: #3498db;
        color: white;
    }
</style>
<div class="weekly-header">
    <a href="{{ url_for('activities_page', start_date=prev_week) }}" class="nav-btn">&larr; Anterior</a>

    <div style="display: flex; flex-direction: column; align-items: center;">
        <h2 style="margin: 0; margin-bottom: 5px;">Semana del {{ start_date.strftime('%d/%m') }}</h2>
        <div class="view-toggle">
            <a href="#" class="active">Semana</a>
            <a
                href="{{ url_for('activities_page', view='month', year=start_date.year, month=start_date.month) }}">Mes</a>
        </div>
    </div>

    <a href="{{ url_for('activities_page', start_date=next_week) }}" class="nav-btn">Siguiente &rarr;</a>
</div>

<div class="calendar-wrapper">
    <!-- Time Column (8am to 12am = 16 hours) -->
    <div class="time-column">
        <div style="height: 50px;"></div> <!-- Spacer for header -->
        {% for h in range(8, 25) %}
        <div class="time-slot-label">
            {{ '%02d' % h }}:00
        </div>
        {% endfor %}
    </div>

    <!-- Days Grid -->
    <div class="days-grid">
        {% for day_idx in range(7) %}
        <div class="day-column">
            <div class="day-header">
                {{ days[day_idx] }}
                <span class="date">{{ week_dates[day_idx].strftime('%d/%m') }}</span>
            </div>

            <!-- Grid Lines Background -->
            {% for h in range(8, 25) %}
            <div class="grid-bg-hour" data-date="{{ week_dates[day_idx].strftime('%Y-%m-%d') }}"
                data-hour="{{ '%02d' % h }}" onclick="openAddActivityModal(this.dataset.date, this.dataset.hour)">
            </div>
            {% endfor %}

            <!-- Events -->
            {% for event in events_by_day[day_idx] %}
            {% if event.end_hour > 8 and event.start_hour < 24 %} {% set start=event.start_hour if event.start_hour>= 8
                else 8 %}
                {% set end = event.end_hour if event.end_hour <= 24 else 24 %} {% set duration=end - start %} {% set
                    top=(start - 8) * 50 %} <!-- 50px per hour, starting at 8am -->
                    {% set height = duration * 50 %}

                    {% set width = event.width|default(100) %}
                    {% set left = event.left|default(0) %}

                    <!-- Event Card -->
                    <div class="event-card" data-id="{{ event.id }}" {% if current_user.pediatrician_id and
                        (current_user.pediatrician.name==event.ped_name or current_user.role=='manager' ) and
                        event.type=='activity' %} {% endif %} {% if event.type=='activity' %} onclick="openEditActivityModal({
                            id: '{{ event.id }}',
                            typeId: '{{ event.activity_type_id }}',
                            start: '{{ event.start_iso }}',
                            end: '{{ event.end_iso }}',
                            recurrence: '{{ event.recurrence_type }}',
                            date: '{{ event.start_iso[:10] }}',
                            description: '{{ event.description | default("") | replace("'", "\\'") | replace(" \n", " "
                        ) }}' })" draggable="true"
                        style="top: {{ top + 50 }}px; height: {{ height }}px; background-color: {{ event.color }}; 
                               width: calc({{ width }}% - 4px); left: calc({{ left }}% + 2px); pointer-events: auto; cursor: pointer;" {% else %}
                        style="top: {{ top + 50 }}px; height: {{ height }}px; background-color: {{ event.color }}; 
                               width: calc({{ width }}% - 4px); left: calc({{ left }}% + 2px); pointer-events: none;"
                        {% endif %}>
                        <span class="event-title">{{ event.title }}</span>
                        <span class="event-time">
                            {{ '%02d:00' % event.start_hour|int }} - {{ '%02d:00' % event.end_hour|int }}
                        </span>
                        {% if event.place %}
                        <div style="font-size: 0.8em; margin-top: 2px;">游늸 {{ event.place }}</div>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endfor %}
        </div>
        {% endfor %}
    </div>
</div>

<div style="margin-top: 20px; display: flex; gap: 20px; justify-content: center;">
    <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 15px; height: 15px; background: #48bb78; border-radius: 3px;"></div>
        <span>Guardias</span>
    </div>
    <div style="display: flex; align-items: center; gap: 5px;">
        <div style="width: 15px; height: 15px; background: #4299e1; border-radius: 3px;"></div>
        <span>Mis Actividades</span>
    </div>
</div>

<!-- Add/Edit Activity Modal -->
<div id="addActivityModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div
        style="background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h3 id="modalTitle" style="margin-top: 0;">A침adir Actividad</h3>

        <form id="activityForm" action="{{ url_for('add_activity') }}" method="POST">
            <input type="hidden" name="next" value="{{ request.url }}">
            <input type="hidden" name="activity_id" id="modal_activity_id">

            <div class="form-group">
                <label>Tipo de Actividad</label>
                <select name="activity_type_id" id="modal_activity_type" required
                    style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    <option value="" disabled selected>Selecciona un tipo</option>
                    {% for type in activity_types %}
                    <option value="{{ type.id }}">{{ type.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Inicio</label>
                <input type="datetime-local" name="start_time" id="modal_start_time" required
                    style="width: 100%; padding: 8px; margin-bottom: 10px;">
            </div>

            <div class="form-group">
                <label>Fin</label>
                <input type="datetime-local" name="end_time" id="modal_end_time" required
                    style="width: 100%; padding: 8px; margin-bottom: 10px;">
            </div>

            <div class="form-group">
                <label>Repetici칩n</label>
                <select name="recurrence_type" id="modal_recurrence"
                    style="width: 100%; padding: 8px; margin-bottom: 15px;">
                    <option value="once">Solo una vez</option>
                    <option value="weekly">Semanalmente</option>
                </select>
            </div>

            <div class="form-group">
                <label>Descripci칩n (Opcional)</label>
                <p style="color: #e53e3e; font-weight: bold; font-size: 0.85em; margin-top: 0; margin-bottom: 5px;">
                    丘멆잺 Por favor, NO introduzca nombres de pacientes ni datos cl칤nicos en este campo.
                </p>
                <textarea name="description" id="modal_description" rows="2"
                    placeholder="Ej: Reuni칩n de equipo, Formaci칩n..."
                    style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; outline-color: #e53e3e;"></textarea>
            </div>

            {% if current_user.role in ['manager', 'admin', 'superadmin'] %}
            <div class="form-group" id="participants-container">
                <label>Participantes (Solo al crear)</label>
                <small style="display:block; color: #666; margin-bottom: 5px;">Manten pulsado Ctrl (o Cmd) para
                    seleccionar varios. Si est치 vac칤o, solo t칰.</small>
                <select name="participants" id="modal_participants" multiple
                    style="width: 100%; padding: 8px; margin-bottom: 10px; height: 100px;">
                    {% for user in service_users %}
                    <option value="{{ user.id }}">{{ user.username }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div style="display: flex; justify-content: space-between; align-items: center;">
                <!-- Left side: Delete button (only visible in edit mode) -->
                <button type="button" id="btnDelete" onclick="attemptDelete()"
                    style="display:none; padding: 8px 15px; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">Eliminar</button>

                <!-- Right side: Cancel/Save -->
                <div style="display: flex; gap: 10px; margin-left: auto;">
                    <button type="button" onclick="closeAddActivityModal()"
                        style="padding: 8px 15px; background: #ccc; border: none; border-radius: 4px; cursor: pointer;">Cancelar</button>
                    <button type="submit"
                        style="padding: 8px 15px; background: #48bb78; color: white; border: none; border-radius: 4px; cursor: pointer;">Guardar</button>
                </div>
            </div>
        </form>

        <!-- Delete Confirmation for Recurring -->
        <div id="deleteOptions" style="display: none; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
            <p style="margin-bottom: 10px; font-weight: bold; color: #e53e3e;">쮺칩mo quieres eliminar esta actividad?
            </p>
            <div style="display: flex; gap: 10px; justify-content: space-between;">
                <button type="button" onclick="confirmDelete('single')"
                    style="flex: 1; padding: 8px; background: #ECC94B; color: black; border: none; border-radius: 4px; cursor: pointer;">Solo
                    esta</button>
                <button type="button" onclick="confirmDelete('all')"
                    style="flex: 1; padding: 8px; background: #e53e3e; color: white; border: none; border-radius: 4px; cursor: pointer;">Todas</button>
            </div>
            <button type="button" onclick="cancelDelete()"
                style="width: 100%; margin-top: 5px; padding: 5px; background: transparent; border: none; color: #666; cursor: pointer; text-decoration: underline;">Cancelar
                borrado</button>
        </div>

        <!-- Hidden Delete Form -->
        <form id="deleteForm" method="POST" style="display: none;">
            <input type="hidden" name="next" value="{{ request.url }}">
            <input type="hidden" name="delete_mode" id="delete_mode">
            <input type="hidden" name="date" id="delete_date">
        </form>
    </div>
</div>

<script>
    let currentActivity = {};

    function openAddActivityModal(dateStr, hourStr) {
        // RESET FORM for "Add" mode
        document.getElementById('modalTitle').innerText = "A침adir Actividad";
        document.getElementById('modal_activity_id').value = "";
        document.getElementById('modal_activity_type').value = "";
        document.getElementById('modal_recurrence').value = "once";
        document.getElementById('modal_activity_type').value = "";
        document.getElementById('modal_recurrence').value = "once";
        document.getElementById('modal_description').value = ""; // Reset description

        // Reset Participants
        const partSelect = document.getElementById('modal_participants');
        if (partSelect) {
            partSelect.selectedIndex = -1;
            document.getElementById('participants-container').style.display = 'block'; // Show for Create
        }

        document.getElementById('btnDelete').style.display = 'none';

        // Hide delete options
        document.getElementById('deleteOptions').style.display = 'none';

        // Construct ISO datetime string
        const startDateTime = `${dateStr}T${hourStr}:00`;
        let startDate = new Date(startDateTime);
        let endDate = new Date(startDate.getTime() + 60 * 60 * 1000); // Add 1 hour

        function formatDT(d) {
            const pad = (n) => n.toString().padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        document.getElementById('modal_start_time').value = startDateTime;
        document.getElementById('modal_end_time').value = formatDT(endDate);

        const modal = document.getElementById('addActivityModal');
        modal.style.display = 'flex';
    }

    function openEditActivityModal(dataset) {
        // dataset is a JS object passed from onclick
        currentActivity = dataset;

        // Stop propagation (though pure JS call handles it, ensure event is available if needed)
        if (window.event) window.event.stopPropagation();

        // POPULATE FORM for "Edit" mode
        document.getElementById('modalTitle').innerText = "Modificar Actividad";
        document.getElementById('modal_activity_id').value = dataset.id;
        document.getElementById('modal_activity_type').value = dataset.typeId;
        document.getElementById('modal_start_time').value = dataset.start;
        document.getElementById('modal_end_time').value = dataset.end;
        document.getElementById('modal_start_time').value = dataset.start;
        document.getElementById('modal_end_time').value = dataset.end;
        document.getElementById('modal_recurrence').value = dataset.recurrence;
        document.getElementById('modal_description').value = dataset.description; // Set description

        // Hide Participants
        const partContainer = document.getElementById('participants-container');
        if (partContainer) partContainer.style.display = 'none';

        document.getElementById('btnDelete').style.display = 'block';
        document.getElementById('deleteOptions').style.display = 'none';

        // Setup Delete Action Base
        const deleteForm = document.getElementById('deleteForm');
        deleteForm.action = "/activities/delete/" + dataset.id;
        document.getElementById('delete_date').value = dataset.date;

        const modal = document.getElementById('addActivityModal');
        modal.style.display = 'flex';
    }

    function attemptDelete() {
        if (currentActivity.recurrence === 'weekly') {
            // Show options
            document.getElementById('deleteOptions').style.display = 'block';
        } else {
            // Confirm normal delete
            if (confirm("쮼st치s seguro de que quieres eliminar esta actividad?")) {
                confirmDelete('all');
            }
        }
    }

    function cancelDelete() {
        document.getElementById('deleteOptions').style.display = 'none';
    }

    function confirmDelete(mode) {
        document.getElementById('delete_mode').value = mode;
        document.getElementById('deleteForm').submit();
    }

    function closeAddActivityModal() {
        document.getElementById('addActivityModal').style.display = 'none';
    }

    // Close modal if clicking outside
    document.getElementById('addActivityModal').addEventListener('click', function (e) {
        if (e.target === this) {
            closeAddActivityModal();
        }
    });
    // Drag & Drop for Activities
    document.addEventListener('DOMContentLoaded', function () {
        const cards = document.querySelectorAll('.event-card[draggable="true"]');
        cards.forEach(card => {
            card.addEventListener('dragstart', function (e) {
                e.dataTransfer.setData('activityId', this.dataset.id);
                this.style.opacity = '0.5';
            });
            card.addEventListener('dragend', function (e) {
                this.style.opacity = '1';
            });
        });

        const allCards = document.querySelectorAll('.event-card');
        allCards.forEach(target => {
            target.addEventListener('dragover', function (e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            target.addEventListener('drop', function (e) {
                e.preventDefault();
                e.stopPropagation();

                const sourceId = e.dataTransfer.getData('activityId');
                const targetId = this.dataset.id;

                if (!sourceId || !targetId || sourceId === targetId) return;

                if (confirm("쯉olicitar intercambio de esta actividad?")) {
                    fetch("{{ url_for('request_activity_swap') }}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ source_id: sourceId, target_id: targetId })
                    })
                        .then(r => r.json())
                        .then(data => {
                            if (data.status === 'success') alert('Solicitud enviada.');
                            else alert('Error: ' + data.message);
                        });
                }
            });
        });
    });
</script>
{% endblock %}