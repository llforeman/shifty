{% extends "base.html" %}

{% block title %}Configuración - Shifty{% endblock %}

{% block extra_styles %}
<style>
    .config-group {
        margin-bottom: 30px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 6px;
        background: #f9f9f9;
    }

    label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }

    input[type="text"],
    input[type="number"],
    select {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }

    input[type="submit"],
    button[type="submit"] {
        background-color: #3498db;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 20px;
        font-size: 16px;
    }

    input[type="submit"]:hover,
    button[type="submit"]:hover {
        background-color: #2980b9;
    }

    .penalty {
        color: #e74c3c;
    }

    h2 {
        color: #555;
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
        margin-top: 30px;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<h1>Dashboard de Configuración</h1>

{% if request.args.get('success') %}
<div class="alert alert-success">
    {{ request.args.get('success') }}
</div>
{% endif %}

{% if request.args.get('error') %}
<div class="alert alert-error">
    {{ request.args.get('error') }}
</div>
{% endif %}

<div style="background: #e7f3ff; padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #b3d9ff;">
    <h3 style="margin-top: 0;">Generar Horario</h3>
    <p>Selecciona el rango de meses (mínimo 1, máximo 6 meses)</p>

    <div id="status-message" style="display: none; padding: 10px; margin-bottom: 15px; border-radius: 4px;"></div>

    <form id="generate-form">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
                <label for="start_year">Año Inicio:</label>
                <input type="number" id="start_year" name="start_year" value="2026" min="2020" max="2030" required>
            </div>
            <div>
                <label for="start_month">Mes Inicio:</label>
                <select id="start_month" name="start_month" required>
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m==1 %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="end_year">Año Fin:</label>
                <input type="number" id="end_year" name="end_year" value="2026" min="2020" max="2030" required>
            </div>
            <div>
                <label for="end_month">Mes Fin:</label>
                <select id="end_month" name="end_month" required>
                    {% for m in range(1, 13) %}
                    <option value="{{ m }}" {% if m==6 %}selected{% endif %}>{{ m }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <button type="submit" id="submit-btn" style="background-color: #28a745;">
            Generar Horario
        </button>
        <div id="spinner" style="display: none; margin-top: 10px;">
            <div
                style="border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;">
            </div>
        </div>
    </form>
</div>

<script>
    document.getElementById('generate-form').addEventListener('submit', async function (e) {
        e.preventDefault();

        const submitBtn = document.getElementById('submit-btn');
        const spinner = document.getElementById('spinner');
        const statusMsg = document.getElementById('status-message');

        // Disable button and show spinner
        submitBtn.disabled = true;
        spinner.style.display = 'block';
        statusMsg.style.display = 'none';

        // Get form data
        const formData = new FormData(this);

        try {
            // Submit job
            const response = await fetch('{{ url_for("generate_schedule_route") }}', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.status === 'queued') {
                // Show queued message
                statusMsg.textContent = data.message + ' - Procesando...';
                statusMsg.style.background = '#fff3cd';
                statusMsg.style.color = '#856404';
                statusMsg.style.display = 'block';

                // Start polling for job status
                pollJobStatus(data.job_id);
            } else {
                throw new Error(data.message || 'Unknown error');
            }
        } catch (error) {
            statusMsg.textContent = 'Error: ' + error.message;
            statusMsg.style.background = '#f8d7da';
            statusMsg.style.color = '#721c24';
            statusMsg.style.display = 'block';
            submitBtn.disabled = false;
            spinner.style.display = 'none';
        }
    });

    function pollJobStatus(jobId) {
        const statusMsg = document.getElementById('status-message');
        const submitBtn = document.getElementById('submit-btn');
        const spinner = document.getElementById('spinner');

        const pollInterval = setInterval(async () => {
            try {
                const response = await fetch(`/job_status/${jobId}`);
                const data = await response.json();

                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    statusMsg.textContent = data.result.message || 'Horario generado exitosamente!';
                    statusMsg.style.background = '#d4edda';
                    statusMsg.style.color = '#155724';
                    submitBtn.disabled = false;
                    spinner.style.display = 'none';
                } else if (data.status === 'failed') {
                    clearInterval(pollInterval);
                    statusMsg.textContent = 'Error: ' + (data.error || 'Generation failed');
                    statusMsg.style.background = '#f8d7da';
                    statusMsg.style.color = '#721c24';
                    submitBtn.disabled = false;
                    spinner.style.display = 'none';
                } else if (data.status === 'running') {
                    statusMsg.textContent = data.message || 'Generando horario...';
                }
            } catch (error) {
                clearInterval(pollInterval);
                statusMsg.textContent = 'Error checking job status';
                statusMsg.style.background = '#f8d7da';
                statusMsg.style.color = '#721c24';
                submitBtn.disabled = false;
                spinner.style.display = 'none';
            }
        }, 2000); // Poll every 2 seconds
    }
</script>

<p>Aquí puede ajustar las variables que afectan a la lógica de optimización del algoritmo PuLP.</p>

<form method="POST">
    <h2>Criterios de Capacidad y Horizonte</h2>
    <div class="config-group">
        <label for="S1">S1 - Mínimo de Pediatras por Día:</label>
        <input type="text" id="S1" name="S1" value="{{ config.S1 }}" required>

        <label for="S2">S2 - Máximo de Pediatras por Día:</label>
        <input type="text" id="S2" name="S2" value="{{ config.S2 }}" required>

        <label for="M_START">M_START - Días de solapamiento inicial (lookahead):</label>
        <input type="text" id="M_START" name="M_START" value="{{ config.M_START }}" required>

        <label for="M_MIN">M_MIN - Días de solapamiento mínimo:</label>
        <input type="text" id="M_MIN" name="M_MIN" value="{{ config.M_MIN }}" required>

        <label for="USE_LEXICOGRAPHIC_FAIRNESS">USE_LEXICOGRAPHIC_FAIRNESS (True/False):</label>
        <input type="text" id="USE_LEXICOGRAPHIC_FAIRNESS" name="USE_LEXICOGRAPHIC_FAIRNESS"
            value="{{ config.USE_LEXICOGRAPHIC_FAIRNESS }}" required>
    </div>

    <h2>Pesos de Penalización (Dureza y Equidad)</h2>
    <div class="config-group">
        {% for key, value in config.items() %}
        {% if key.startswith('PENALTY_') %}
        <label for="{{ key }}" class="penalty">{{ key.replace('PENALTY_', '') }}:</label>
        <input type="text" id="{{ key }}" name="{{ key }}" value="{{ value }}" required>
        {% endif %}
        {% endfor %}
        <label for="BALANCE_ALPHA">BALANCE_ALPHA (Ajuste de Equidad):</label>
        <input type="text" id="BALANCE_ALPHA" name="BALANCE_ALPHA" value="{{ config.BALANCE_ALPHA }}" required>
    </div>

    <input type="submit" value="Guardar Cambios de Configuración">
</form>
{% endblock %}