{% extends "base.html" %}

{% block title %}Calendario - Shifty{% endblock %}

{% block extra_styles %}
<style>
    .nav-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .nav-btn {
        background-color: #3498db;
        color: white;
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;
    }

    .nav-btn:hover {
        background-color: #2980b9;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
    }

    .day-header {
        text-align: center;
        font-weight: bold;
        background: #ecf0f1;
        padding: 10px;
        border-radius: 4px;
    }

    .day-cell {
        background: #fff;
        border: 1px solid #ddd;
        min-height: 120px;
        padding: 10px;
        border-radius: 4px;
    }

    .day-number {
        font-weight: bold;
        margin-bottom: 5px;
        display: block;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }

    .shift-item {
        background: #e3f2fd;
        color: #0d47a1;
        padding: 4px;
        margin-bottom: 4px;
        border-radius: 3px;
        font-size: 0.9em;
    }

    .shift-item.my-shift {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        font-weight: bold;
    }

    .empty-cell {
        background: #f9f9f9;
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="nav-header">
    <a href="{{ url_for('calendar_view', year=prev_year, month=prev_month) }}" class="nav-btn">&larr; Anterior</a>
    <h1 style="margin: 0;">{{ month_name }} {{ year }}</h1>
    <a href="{{ url_for('calendar_view', year=next_year, month=next_month) }}" class="nav-btn">Siguiente &rarr;</a>
</div>

{% if is_draft and current_user.role == 'manager' %}
<div
    style="background-color: #fff3cd; color: #856404; padding: 15px; margin-bottom: 20px; border-radius: 4px; border: 1px solid #ffeeba; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <strong>MODO BORRADOR (DRAFT)</strong> - Estás viendo el calendario generado provisionalmente.
    </div>
    <form action="{{ url_for('publish_schedule', year=year, month=month) }}" method="POST" style="margin: 0;">
        <button type="submit" class="nav-btn" style="background-color: #28a745; border: none; cursor: pointer;">Publicar
            Horario</button>
    </form>
</div>
{% endif %}

<div style="margin-bottom: 10px; text-align: center;">
    {% if current_user.role == 'manager' %}
    {% if is_draft %}
    <a href="{{ url_for('calendar_view', year=year, month=month) }}" class="nav-btn"
        style="background-color: #6c757d; font-size: 0.9em;">Ver Calendario Publicado</a>
    {% else %}
    <a href="{{ url_for('calendar_view', year=year, month=month, mode='draft') }}" class="nav-btn"
        style="background-color: #e0a800; font-size: 0.9em;">Ver Borrador (Draft)</a>
    {% endif %}
    {% endif %}
</div>

{% if next_shift_date %}
<div
    style="background-color: #d4edda; color: #155724; padding: 15px; margin-bottom: 20px; border-radius: 4px; border: 1px solid #c3e6cb; text-align: center;">
    <strong>¡Atención!</strong> No hay turnos en este mes. El próximo horario generado comienza en
    <a href="{{ url_for('calendar_view', year=next_shift_date.year, month=next_shift_date.month) }}"
        style="font-weight: bold; color: #155724; text-decoration: underline;">
        {{ next_shift_date.strftime('%B %Y') }}
    </a>.
</div>
{% endif %}

<div class="calendar-grid">
    <div class="day-header">Lun</div>
    <div class="day-header">Mar</div>
    <div class="day-header">Mié</div>
    <div class="day-header">Jue</div>
    <div class="day-header">Vie</div>
    <div class="day-header">Sáb</div>
    <div class="day-header">Dom</div>

    {% for week in month_calendar %}
    {% for day in week %}
    {% if day == 0 %}
    <div class="day-cell empty-cell"></div>
    {% else %}
    <div class="day-cell" data-date="{{ year }}-{{ '%02d' % month }}-{{ '%02d' % day }}">
        <span class="day-number">{{ day }}</span>
        {% if shifts.get(day) %}
        {% for shift in shifts[day] %}
        <div class="shift-item {{ 'my-shift' if current_user.pediatrician_id == shift.pediatrician_id else '' }}" {% if
            current_user.role=='manager' or (current_user.pediatrician_id==shift.pediatrician_id) %} draggable="true"
            data-shift-id="{{ shift.id }}" data-ped-id="{{ shift.pediatrician_id }}" style="cursor: grab;" {% endif %}>
            {{ shift.pediatrician.name }}
        </div>
        {% endfor %}
        {% endif %}
    </div>
    {% endif %}
    {% endfor %}
    {% endfor %}
</div>

{% if current_user.is_authenticated %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        const shifts = document.querySelectorAll('.shift-item[draggable="true"]');
        const cells = document.querySelectorAll('.day-cell:not(.empty-cell)');

        let draggedItem = null;

        shifts.forEach(shift => {
            shift.addEventListener('dragstart', function (e) {
                draggedItem = this;
                e.dataTransfer.setData('shiftId', this.dataset.shiftId);
                e.dataTransfer.effectAllowed = 'move';
                setTimeout(() => this.style.opacity = '0.5', 0);
            });

            shift.addEventListener('dragend', function () {
                setTimeout(() => {
                    this.style.opacity = '1';
                    draggedItem = null;
                }, 0);
            });
        });

        cells.forEach(cell => {
            cell.addEventListener('dragover', function (e) {
                // Must call preventDefault to allow dropping
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                this.style.backgroundColor = '#f0f0f0';
            });

            cell.addEventListener('dragleave', function () {
                this.style.backgroundColor = '#fff';
            });

            cell.addEventListener('drop', function (e) {
                e.preventDefault();
                this.style.backgroundColor = '#fff';

                // Get the dragged shift ID
                const shiftId = e.dataTransfer.getData('shiftId');

                // Find where we dropped it
                const targetDate = this.dataset.date;

                // Check if dropped on another shift inside the cell
                let targetShiftId = null;
                let targetElement = e.target;

                // Traverse up to find if we dropped on a shift-item
                while (targetElement && targetElement !== this) {
                    if (targetElement.classList.contains('shift-item')) {
                        targetShiftId = targetElement.dataset.shiftId;
                        break;
                    }
                    targetElement = targetElement.parentElement;
                }

                if (!shiftId || !targetDate) return;

                // Don't do anything if dropped on itself
                if (shiftId === targetShiftId) return;

                const isManager = {{ 'true' if current_user.role == 'manager' else 'false'
            }};

        if (isManager) {
            // ADMIN SWAP LOGIC (Direct Execution)
            fetch('{{ url_for("swap_shifts") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    source_id: shiftId,
                    target_id: targetShiftId,
                    target_date: targetDate,
                    mode: '{{ "draft" if is_draft else "live" }}'
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') location.reload();
                    else alert('Error: ' + data.message);
                });
        } else {
            // USER SWAP REQUEST LOGIC
            if (!targetShiftId) {
                alert("Para solicitar un cambio, arrastra TU tarjeta (verde) y suéltala ENCIMA de la tarjeta de la persona con la que quieres cambiar. No puedes moverte a un día vacío.");
                return;
            }

            if (confirm("¿Quieres solicitar un cambio de turno con esta persona?")) {
                fetch('{{ url_for("request_swap") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_shift_id: shiftId,
                        target_shift_id: targetShiftId
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') alert("Solicitud enviada!");
                        else alert('Error: ' + data.message);
                    });
            }
        }
    });
        });
    });
</script>
{% endif %}
{% endblock %}