{% extends "base.html" %}

{% block title %}Calendario Global - Shifty{% endblock %}

{% block extra_styles %}
<style>
    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* ACTIVITY VERTICAL VIEW */
    .activity-view-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .activity-view-table th,
    .activity-view-table td {
        border: 1px solid #ddd;
        padding: 8px;
        vertical-align: top;
    }

    .activity-view-table th {
        background: #f8f9fa;
        text-align: center;
    }

    .activity-row-header {
        background: #f1f3f5;
        font-weight: bold;
        width: 150px;
    }

    .activity-cell {
        position: relative;
        padding: 0 !important;
        background-color: #fff;
        /* Grid lines: 24h = 100%. 1 hour ~ 4.16% */
        background-image: linear-gradient(to right, #f1f3f5 1px, transparent 1px);
        background-size: 4.166% 100%;
        min-height: 50px;
    }

    .row-label {
        position: absolute;
        width: 100%;
        height: 20px;
        line-height: 20px;
        font-size: 11px;
        color: #495057;
        text-align: center;
        z-index: 5;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 600;
        pointer-events: none;
        /* Let clicks pass through */
    }

    .timeline-event {
        position: absolute;
        height: 20px;
        border-radius: 3px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        z-index: 10;
        cursor: pointer;
        opacity: 0.2;
        /* Significantly more transparent */
        transition: opacity 0.1s, transform 0.1s;
    }

    .timeline-event:hover {
        z-index: 20;
        opacity: 1.0;
        transform: scaleY(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-controls">
    <div>
        <a href="{{ url_for('global_calendar', week_offset=week_offset-1, view=view_mode) }}"
            class="btn btn-sm btn-secondary">&lt;
            Anterior</a>
        <span style="font-size: 1.2em; font-weight: bold; margin: 0 15px;">
            Semana {{ start_date.strftime('%d/%m') }} - {{ end_date.strftime('%d/%m/%Y') }}
        </span>
        <a href="{{ url_for('global_calendar', week_offset=week_offset+1, view=view_mode) }}"
            class="btn btn-sm btn-secondary">Siguiente
            &gt;</a>
    </div>

    <!-- View Mode Toggles -->
    <div class="btn-group" role="group">
        <a href="{{ url_for('global_calendar', view='activities', week_offset=request.args.get('week_offset', 0)) }}"
            class="btn {{ 'btn-primary' if view_mode == 'activities' else 'btn-outline-primary' }}">
            Por Actividad
        </a>
        <a href="{{ url_for('global_calendar', view='users', week_offset=request.args.get('week_offset', 0)) }}"
            class="btn {{ 'btn-primary' if view_mode == 'users' else 'btn-outline-primary' }}">
            Por Usuario
        </a>
    </div>
</div>

<!-- VIEW: ACTIVITY VERTICAL -->
<div id="activity-view" class="view-container">
    <table class="activity-view-table">
        <thead>
            <tr>
                <th style="width: 150px;">
                    {{ 'Usuario' if view_mode == 'users' else 'Actividad' }}
                </th>
                {% for day in days %}
                <th>{{ day_names[loop.index0] }}<br><small>{{ day.strftime('%d/%m') }}</small></th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for activity_type, activity_data in events_by_activity.items() %}
            <tr>
                <td class="activity-row-header">{{ activity_type }}</td>
                {% for day in days %}
                {% set date_str = day.strftime('%Y-%m-%d') %}
                {% set cell_h = cell_heights.get(activity_type, {}).get(date_str, 50) %}

                <td class="activity-cell" style="height: {{ cell_h }}px;">

                    <!-- TIMELINE VIEW -->

                    <!-- Background Names -->
                    {% set day_owners = row_owners.get(activity_type, {}).get(date_str, {}) %}
                    {% for row_idx, owner_name in day_owners.items() %}
                    <div class="row-label" style="top: {{ row_idx * 25 }}px;">
                        {{ owner_name }}
                    </div>
                    {% endfor %}

                    <!-- Timeline Events -->
                    {% if activity_data[date_str] %}
                    {% for event in activity_data[date_str] %}
                    <div class="timeline-event" title="{{ event.pediatrician }} ({{ event.time_str }})"
                        style="left: {{ event.left }}%; 
                                   top: {{ event.top }}px; 
                                   background-color: {{ event.color }};
                                   {{ 'border-top-left-radius: 0; border-bottom-left-radius: 0;' if event.blend_left else '' }}
                                   {{ 'border-top-right-radius: 0; border-bottom-right-radius: 0; width: calc(' ~ event.width ~ '% + 1px);' if event.blend_right else 'width: ' ~ event.width ~ '%;' }}">
                    </div>
                    {% endfor %}
                    {% endif %}



                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}