{% extends "base.html" %}

{% block title %}Calendario Global - Shifty{% endblock %}

{% block extra_styles %}
<style>
    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .view-toggle {
        display: flex;
        gap: 10px;
    }

    .view-btn {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: #f8f9fa;
        cursor: pointer;
        border-radius: 4px;
        font-weight: bold;
    }

    .view-btn.active {
        background: #3498db;
        color: white;
        border-color: #3498db;
    }

    /* TIME VERTICAL VIEW (Standard) */
    .time-view-grid {
        display: grid;
        grid-template-columns: 60px repeat(7, 1fr);
        /* Time col + 7 days */
        gap: 1px;
        background: #eee;
        border: 1px solid #ddd;
    }

    .grid-header {
        background: #fff;
        padding: 10px;
        text-align: center;
        font-weight: bold;
        border-bottom: 1px solid #ddd;
    }

    .time-slot {
        background: white;
        border-bottom: 1px solid #f0f0f0;
        height: 100px;
        /* Fixed height for simplicity now, can be dynamic */
        padding: 5px;
        font-size: 0.85em;
        overflow-y: auto;
    }

    .time-label {
        background: #f8f9fa;
        text-align: right;
        padding-right: 10px;
        font-weight: bold;
        color: #666;
        display: flex;
        align-items: center;
        justify-content: flex-end;
    }

    .event-card {
        padding: 2px 5px;
        margin-bottom: 2px;
        border-radius: 3px;
        color: white;
        font-size: 0.8em;
        cursor: pointer;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ACTIVITY VERTICAL VIEW */
    .activity-view-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .activity-view-table th,
    .activity-view-table td {
        border: 1px solid #ddd;
        padding: 8px;
        vertical-align: top;
    }

    .activity-view-table th {
        background: #f8f9fa;
        text-align: center;
    }

    .activity-row-header {
        background: #f1f3f5;
        font-weight: bold;
        width: 150px;
    }

    .activity-cell {
        min-height: 50px;
    }

    .staff-item {
        display: block;
        padding: 2px 6px;
        margin-bottom: 2px;
        background: #e3f2fd;
        border-left: 3px solid #2196f3;
        border-radius: 2px;
        font-size: 0.85em;
    }

    .staff-time {
        font-size: 0.75em;
        color: #666;
        margin-left: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-controls">
    <div>
        <a href="{{ url_for('global_calendar', week_offset=week_offset-1) }}" class="btn btn-sm btn-secondary">&lt;
            Anterior</a>
        <span style="font-size: 1.2em; font-weight: bold; margin: 0 15px;">
            Semana {{ start_date.strftime('%d/%m') }} - {{ end_date.strftime('%d/%m/%Y') }}
        </span>
        <a href="{{ url_for('global_calendar', week_offset=week_offset+1) }}" class="btn btn-sm btn-secondary">Siguiente
            &gt;</a>
    </div>

    <div class="view-toggle">
        <button class="view-btn active" onclick="switchView('time')">Vista Horaria (Semanal)</button>
        <button class="view-btn" onclick="switchView('activity')">Vista por Actividad</button>
    </div>
</div>

<!-- VIEW 1: TIME VERTICAL -->
<div id="time-view" class="view-container">
    <div class="time-view-grid">
        <!-- Header Row -->
        <div class="grid-header">Hora</div>
        {% for day in days %}
        <div class="grid-header">{{ day_names[loop.index0] }}<br><small>{{ day.strftime('%d/%m') }}</small></div>
        {% endfor %}

        <!-- Grid Content: Simplified to Morning/Afternoon slots or Hourly? 
             User asked for "vertical axis being time (8am to 12pm)". 
             Let's do broad slots first (Morning, Afternoon) or hourly blocks.
             For now, let's just dump events in day columns for simplicity of rendering 
             without complex geometric calculations in backend. 
        -->

        <!-- We will render one big cell per day to let events stack naturally for now, 
             or we can do rough time blocks. The user requested specifically "vertical axis time".
             Let's simulate 8am-8pm using a single flexible column per day for now 
             where we place div blocks. 
        -->
    </div>

    <!-- Alternative Simple Week Grid -->
    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 10px;">
        {% for day in days %}
        <div style="background: white; border: 1px solid #ccc; min-height: 400px; padding: 5px;">
            <div style="text-align: center; border-bottom: 1px solid #eee; margin-bottom: 5px; font-weight: bold;">
                {{ day_names[loop.index0] }} {{ day.strftime('%d') }}
            </div>
            {% set date_str = day.strftime('%Y-%m-%d') %}
            {% if events_by_date[date_str] %}
            {% for event in events_by_date[date_str] %}
            <div class="event-card" style="background-color: {{ event.color }};" title="{{ event.title }}">
                {{ event.time_str }} <strong>{{ event.title }}</strong>
                <br><small>{{ event.pediatrician }}</small>
            </div>
            {% endfor %}
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<!-- VIEW 2: ACTIVITY VERTICAL -->
<div id="activity-view" class="view-container" style="display: none;">
    <table class="activity-view-table">
        <thead>
            <tr>
                <th style="width: 150px;">Actividad</th>
                {% for day in days %}
                <th>{{ day_names[loop.index0] }} {{ day.strftime('%d/%m') }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for activity_type, activity_data in events_by_activity.items() %}
            <tr>
                <td class="activity-row-header">{{ activity_type }}</td>
                {% for day in days %}
                {% set date_str = day.strftime('%Y-%m-%d') %}
                <td class="activity-cell">
                    {% if activity_data[date_str] %}
                    {% for event in activity_data[date_str] %}
                    <div class="staff-item">
                        {{ event.pediatrician }}
                        <span class="staff-time">({{ event.time_str }})</span>
                    </div>
                    <div style="height: 2px; width: 100%; background: #2196f3; margin-bottom: 5px; opacity: 0.5;"></div>
                    {% endfor %}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    function switchView(viewName) {
        document.getElementById('time-view').style.display = viewName === 'time' ? 'block' : 'none';
        document.getElementById('activity-view').style.display = viewName === 'activity' ? 'block' : 'none';

        document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }
</script>
{% endblock %}